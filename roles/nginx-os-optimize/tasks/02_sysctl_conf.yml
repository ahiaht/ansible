# Allow for more PIDs (to reduce rollover problems); may break some programs 32768
- sysctl:
    name:  kernel.pid_max
    value: '65535'
    state: present
# Increase system IP port limits
- sysctl:
    name:  net.ipv4.ip_local_port_range
    value: '10000 65000'
    state: present
- sysctl:
    name:  net.core.rmem_max
    value: '16777216'
    state: present
- sysctl:
    name:  net.core.wmem_max
    value: '16777216'
    state: present
- sysctl:
    name:  net.core.netdev_max_backlog
    value: '5000'
    state: present
- sysctl:
    name:  net.ipv4.tcp_window_scaling
    value: '1'
    state: present

# Increase TCP max buffer size setable using setsockopt()
- sysctl:
    name:  net.ipv4.tcp_rmem
    value: '4096 87380 16777216'
    state: present
- sysctl:
    name:  net.ipv4.tcp_2mem
    value: '4096 87380 16777216'
    state: present

# When the server has to cycle through a high volume of TCP connections,
# it can build up a large number of connections in TIME_WAIT state.
# TIME_WAIT means a connection is closed but the allocated
# resources are yet to be released. Setting this directive to 1
# will tell the kernel to try to recycle the allocation
# for a new connection when safe to do so.
# This is cheaper than setting up a new connection from scratch.
- sysctl:
    name:  net.ipv4.tcp_tw_reuse
    value: '1'
    state: present

# The minimum number of seconds that must elapse before
# a connection in TIME_WAIT state can be recycled.
# Lowering this value will mean allocations will be recycled faster.
- sysctl:
    name:  net.ipv4.tcp_fin_timeout
    value: '15'
    state: present
# other tunings
- sysctl:
    name:  net.core.somaxconn
    value: '4096'
    state: present
- sysctl:
    name:  net.ipv4.tcp_max_syn_backlog
    value: '20480'
    state: present
- sysctl:
    name:  net.ipv4.tcp_max_tw_buckets
    value: '400000'
    state: present
- sysctl:
    name:  net.ipv4.tcp_no_metrics_save
    value: '1'
    state: present
- sysctl:
    name:  net.ipv4.tcp_syn_retries
    value: '2'
    state: present
- sysctl:
    name:  net.ipv4.tcp_synack_retries
    value: '2'
    state: present
- sysctl:
    name:  vm.min_free_kbytes
    value: '65536'
    state: present
